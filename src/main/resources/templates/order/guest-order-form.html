<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/order-layout}">
<div layout:fragment="content">
    <!-- Main Content -->
    <div class="row">
        <div class="col-12 mt-3 text-center text-uppercase">
            <h2>비회원 주문</h2>
        </div>
    </div>

    <!-- 주문서 영역 -->
    <div class="container mt-5">
        <div class="row">
            <!-- 왼쪽: 주문자 및 배송지 정보, 결제 UI -->
            <div class="col-md-9">
                <div class="row">
                    <!-- 주문자 정보 -->
                    <div class="col-md-12">
                        <div class="card mb-3">
                            <h5 class="mb-0">
                                <button
                                        class="btn btn-link accordion-button"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapseCustomerInfo"
                                        aria-expanded="false"
                                        aria-controls="collapseCustomerInfo"
                                >
                                    주문자 정보
                                </button>
                            </h5>
                            <div
                                    id="collapseCustomerInfo"
                                    class="collapse"
                                    aria-labelledby="headingCustomerInfo"
                            >
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="customer-name">주문자 이름</label>
                                        <input type="text" class="form-control" id="customer-name"
                                               placeholder="이름을 입력하세요."
                                               onfocus="this.placeholder = ''" onblur="this.placeholder = '이름을 입력하세요.'"
                                               required/>
                                    </div>
                                    <div class="form-group">
                                        <label for="customer-password">비밀번호</label>
                                        <input type="password" class="form-control" id="customer-password"
                                               placeholder="비밀번호를 입력하세요."
                                               onfocus="this.placeholder = ''"
                                               onblur="this.placeholder = '비밀번호를 입력하세요.'" required/>
                                    </div>
                                    <div class="form-group">

                                        <input type="password" class="form-control" id="customer-repeat-password"
                                               placeholder="비밀번호를 한번 더 입력하세요."
                                               onfocus="this.placeholder = ''"
                                               onblur="this.placeholder = '비밀번호를 한번 더 입력하세요.'" required/>
                                    </div>
                                    <div class="form-group">
                                        <label for="customer-phone">전화번호</label>
                                        <input type="text" class="form-control" id="customer-phone"
                                               placeholder="전화번호를 입력하세요."
                                               onfocus="this.placeholder = ''"
                                               onblur="this.placeholder = '전화번호를 입력하세요.'" required/>
                                    </div>
                                    <div class="form-group">
                                        <label for="customer-email">이메일</label>
                                        <input type="email" class="form-control" id="customer-email"
                                               placeholder="이메일를 입력하세요."
                                               onfocus="this.placeholder = ''" onblur="this.placeholder = '이메일를 입력하세요.'"
                                               required/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 배송지 정보 -->
                    <div class="col-md-12">
                        <div class="card mb-3">
                            <h5 class="mb-0">
                                <button
                                        class="btn btn-link accordion-button"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapseShippingInfo"
                                        aria-expanded="false"
                                        aria-controls="collapseShippingInfo"
                                >
                                    배송지 정보
                                </button>
                            </h5>
                            <div
                                    id="collapseShippingInfo"
                                    class="collapse"
                                    aria-labelledby="headingShippingInfo"
                            >
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="shipping-address">수취자 이름</label>
                                        <input type="text" class="form-control" id="shipping-name"
                                               placeholder="수취자 이름를 입력하세요"/>
                                    </div>
                                    <div class="form-group">
                                        <label for="shipping-address">수취자 연락처</label>
                                        <input type="text" class="form-control" id="shipping-phone-number"
                                               placeholder="수취자 연락처를 입력하세요"/>
                                    </div>
                                    <div class="form-group">
                                        <input type="button" class="form-control" id="Postcode"
                                               onclick="daumPostcode()" value="도로명 주소 찾기"/>
                                    </div>
                                    <div class="form-group">
                                        <label for="shipping-address">배송지</label>
                                        <input type="text" class="form-control" id="shipping-address"
                                               placeholder="배송지를 입력하세요"/>
                                    </div>
                                    <div class="form-group">
                                        <label for="shipping-address">배송지 상세주소</label>
                                        <input type="text" class="form-control" id="shipping-address-detail"
                                               placeholder="배송지 상세주소를 입력하세요"/>
                                    </div>
                                    <div class="form-group">
                                        <label for="shipping-address">우편번호</label>
                                        <input type="text" class="form-control" id="shipping-zipcode"
                                               placeholder="우편번호를 입력하세요"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 주문 상세 정보 -->
                    <div class="col-md-12">
                        <div class="card mb-3">
                            <h5 class="mb-0">
                                <button
                                        class="btn btn-link accordion-button"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapseOrderDetails"
                                        aria-expanded="false"
                                        aria-controls="collapseOrderDetails"
                                >
                                    주문 상세
                                </button>
                            </h5>
                            <div
                                    id="collapseOrderDetails"
                                    class="collapse"
                                    aria-labelledby="headingOrderDetails"
                            >

                                <div class="card-body">
                                    <h5>주문 품목</h5>
                                    <table class="table table-borderless">
                                        <tbody>
                                        <!-- 상품 항목 1 -->
                                        <tr>
                                            <td class="d-flex align-items-center">
                                                <!-- 썸네일 -->
                                                <img src="https://via.placeholder.com/100" class="img-fluid mr-3"
                                                     alt="상품 이미지">
                                            </td>
                                            <td>
                                                <h6 class="mb-1">토스 티셔츠</h6>
                                            </td>
                                            <td>
                                                <!-- 상품 정보 -->
                                                <div>
                                                    <div>가격: <span class="original-price">20,000원</span></div>
                                                    <div>세일가: <span class="sale-price">15,000원</span></div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="mt-2">
                                                    <label for="item-quantity">수량:</label>
                                                    <span class="item-quantity" id="item-quantity">1개</span>
                                                </div>
                                            </td>
                                        </tr>
                                        <!-- 상품 항목 2 -->
                                        <tr>
                                            <td class="d-flex align-items-center">
                                                <!-- 썸네일 -->
                                                <img src="https://via.placeholder.com/100" class="img-fluid mr-3"
                                                     alt="상품 이미지">
                                            </td>
                                            <td>
                                                <h6 class="mb-1">토스 티셔츠</h6>
                                            </td>
                                            <td>
                                                <!-- 상품 정보 -->
                                                <div>
                                                    <div>가격: <span class="original-price">20,000원</span></div>
                                                    <div>세일가: <span class="sale-price">15,000원</span></div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="mt-2">
                                                    <label for="item-quantity2">수량:</label>
                                                    <span class="item-quantity" id="item-quantity2">1개</span>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>

                                    <!-- 총합 -->
                                    <div class="text-right">
                                        <p>총 주문 품목: <span id="total-items">2</span>개</p>
                                        <p>배송비: <span id="shipping-cost">3,000원</span></p>
                                        <p>총 결제 금액: <span id="total-price">23,000원</span></p>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>

                    <!-- 결제 UI -->
                    <div class="col-md-12">
                        <div class="card mb-3">
                            <h5 class="mb-0">
                                <button
                                        class="btn btn-link accordion-button"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapsePayment"
                                        aria-expanded="false"
                                        aria-controls="collapsePayment"
                                >
                                    결제
                                </button>
                            </h5>
                            <div
                                    id="collapsePayment"
                                    class="collapse"
                                    aria-labelledby="headingPayment"
                            >
                                <div class="card-body">
                                    <div id="payment-method"></div> <!-- 결제 UI 영역 -->
                                    <div id="agreement"></div> <!-- 이용약관 UI -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 쿠폰 및 포인트 UI 추가 (아코디언) -->
                    <div class="col-md-12">
                        <div class="card mb-3">
                            <h5 class="mb-0">
                                <button
                                        class="btn btn-link accordion-button"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapseCouponPoint"
                                        aria-expanded="false"
                                        aria-controls="collapseCouponPoint"
                                >
                                    쿠폰 및 포인트
                                </button>
                            </h5>
                            <div
                                    id="collapseCouponPoint"
                                    class="collapse"
                                    aria-labelledby="headingCouponPoint"
                            >
                                <div class="card-body">
                                    <!-- 쿠폰 목록 -->
                                    <div class="form-group">
                                        <label for="order-coupon-list">주문에만 사용할 수 있는 쿠폰</label>
                                        <select class="form-control" id="order-coupon-list">
                                            <option>10% 할인 쿠폰</option>
                                            <option>5,000원 할인 쿠폰</option>
                                            <option>1,000원 할인 쿠폰</option>
                                        </select>
                                    </div>

                                    <hr>

                                    <div class="form-group">
                                        <label for="product-coupon-list">상품별로 사용할 수 있는 쿠폰</label>
                                        <select class="form-control" id="product-coupon-list">
                                            <option>토스 티셔츠 20% 할인</option>
                                            <option>토스 머그컵 15% 할인</option>
                                        </select>
                                    </div>

                                    <!-- 포인트 영역 -->
                                    <div class="form-group">
                                        <label for="point-amount">포인트 사용</label>
                                        <div class="d-flex align-items-center">
                                            <!-- 포인트 입력 칸 -->
                                            <input type="number" class="form-control mr-2" id="point-amount"
                                                   placeholder="사용할 포인트 입력"/>

                                            <!-- 전체 사용 버튼 -->
                                            <button class="btn-sm btn-secondary" id="use-all-points">전체 사용</button>
                                        </div>
                                    </div>


                                    <!-- 포인트 잔여량 -->
                                    <div class="form-group">
                                        <label for="remaining-points">잔여 포인트</label>
                                        <input type="text" class="form-control" id="remaining-points" value="10,000"
                                               readonly/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 오른쪽: 결제 금액 -->
            <div class="col-md-3">
                <div id="payment-amount-container">
                    <h5>결제 금액</h5>
                    <div class="form-group">
                        <label for="total-amount">총 결제 금액</label>
                        <input type="text" class="form-control" id="total-amount" value="50,000원" readonly/>
                    </div>

                    <!-- 결제 금액 업데이트 처리 -->
                    <div class="mt-3">
                        <button class="btn btn-primary" id="payment-button">결제하기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Main Content -->

    <!-- Script -->
    <th:block layout:fragment="script">
        <script>
            main();

            // 토스 payments 결제
            async function main() {

                const totalPrice = calculateTotalPrice();

                const button = document.getElementById("payment-button");
                const coupon = document.getElementById("order-coupon-list");

                const amount = {
                    currency: "KRW",
                    value: totalPrice,
                };

                // ------  결제위젯 초기화 ------
                // TODO: clientKey는 개발자센터의 결제위젯 연동 키 > 클라이언트 키로 바꾸세요.
                // TODO: 구매자의 고유 아이디를 불러와서 customerKey로 설정하세요. 이메일・전화번호와 같이 유추가 가능한 값은 안전하지 않습니다.
                // @docs https://docs.tosspayments.com/sdk/v2/js#토스페이먼츠-초기화
                const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
                const customerKey = generateRandomString();
                const tossPayments = TossPayments(clientKey);

                // 회원 결제
                // const widgets = tossPayments.widgets({
                //     customerKey,
                // });

                // 비회원 결제
                const widgets = tossPayments.widgets({customerKey: TossPayments.ANONYMOUS});

                // ------  주문서의 결제 금액 설정 ------
                // TODO: 위젯의 결제금액을 결제하려는 금액으로 초기화하세요.
                // TODO: renderPaymentMethods, renderAgreement, requestPayment 보다 반드시 선행되어야 합니다.
                await widgets.setAmount(amount);

                // ------  결제 UI 렌더링 ------
                // @docs https://docs.tosspayments.com/sdk/v2/js#widgetsrenderpaymentmethods
                await widgets.renderPaymentMethods({
                    selector: "#payment-method",
                    // 렌더링하고 싶은 결제 UI의 variantKey
                    // 결제 수단 및 스타일이 다른 멀티 UI를 직접 만들고 싶다면 계약이 필요해요.
                    // @docs https://docs.tosspayments.com/guides/v2/payment-widget/admin#새로운-결제-ui-추가하기
                    variantKey: "DEFAULT",
                });

                // ------  이용약관 UI 렌더링 ------
                // @docs https://docs.tosspayments.com/reference/widget-sdk#renderagreement선택자-옵션
                await widgets.renderAgreement({selector: "#agreement", variantKey: "AGREEMENT"});

                // ------  주문서의 결제 금액이 변경되었을 경우 결제 금액 업데이트 ------
                // @docs https://docs.tosspayments.com/sdk/v2/js#widgetssetamount
                // coupon.addEventListener("change", async function () {
                //     if (coupon.checked) {
                //         await widgets.setAmount({
                //             currency: "KRW",
                //             value: amount.value - 5000,
                //         });
                //
                //         return;
                //     }
                //
                //     await widgets.setAmount({
                //         currency: "KRW",
                //         value: amount,
                //     });
                // });

                // ------ '결제하기' 버튼 누르면 결제창 띄우기 ------
                // @docs https://docs.tosspayments.com/sdk/v2/js#widgetsrequestpayment
                button.addEventListener("click", async function () {
                    // 결제를 요청하기 전에 orderId, amount를 서버에 저장하세요.
                    // 결제 과정에서 악의적으로 결제 금액이 바뀌는 것을 확인하는 용도입니다.
                    await widgets.requestPayment({
                        orderId: generateRandomString(),
                        orderName: "토스 티셔츠 외 2건",
                        successUrl: window.location.origin + "/orders/success",
                        failUrl: window.location.origin + "/orders/fail",
                        customerEmail: document.getElementById('customer-email').value,
                        customerName: document.getElementById('customer').value,
                        customerMobilePhone: document.getElementById('customer-phone').value,
                    });
                });
            }

            // 주문번호 랜덤
            function generateRandomString() {
                return window.btoa(Math.random()).slice(0, 20);
            }

            // 결제 금액 얻어오기
            function getAllSalePrices() {
                const salePriceElements = document.querySelectorAll('.sale-price');
                const salePrices = Array.from(salePriceElements).map(element => {
                    return parseInt(element.textContent.replace(/[^\d]/g, ''));
                })

                console.log("prices: " + salePrices);  // 예시: [15000, 15000]
                return salePrices;
            }

            // 숫자 포맷팅 함수 (천 단위 구분자 추가)
            function formatPrice(price) {
                return price.toLocaleString() + "원";  // 예: 50000 => "50,000원"
            }

            // 총 결제 금액을 계산하고 input 필드에 값을 넣기
            function calculateTotalPrice() {
                const salePrices = getAllSalePrices();  // 모든 세일가 값을 가져옴
                const totalPrice = salePrices.reduce((total, price) => total + price, 0);  // 총 결제 금액 계산

                // 총 결제 금액을 포맷하여 input 필드에 넣기
                const formattedPrice = formatPrice(totalPrice);  // 포맷된 가격
                document.getElementById('total-amount').value = formattedPrice; // 최종값이라 쿠폰, 배송비도 지원할 것
                document.getElementById('total-price').value = formattedPrice;

                console.log("formattedPrice: " + formattedPrice);  // 예시: "50,000원"
                return totalPrice;  // 포맷된 가격 반환
            }

            // 도로명 주소 처리
            function daumPostcode() {
                new daum.Postcode({
                    oncomplete: function (data) {
                        // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                        // 각 주소의 노출 규칙에 따라 주소를 조합한다.
                        // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                        var addr = ''; // 주소 변수
                        var extraAddr = ''; // 참고항목 변수

                        //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                        if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                            addr = data.roadAddress;
                        } else { // 사용자가 지번 주소를 선택했을 경우(J) 도로명 주소로 변경한다.
                            addr = data.roadAddress;
                        }

                        // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                        // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                        if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                            extraAddr += data.bname;
                        }
                        // 건물명이 있고, 공동주택일 경우 추가한다.
                        if (data.buildingName !== '' && data.apartment === 'Y') {
                            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                        }
                        // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                        if (extraAddr !== '') {
                            extraAddr = ' (' + extraAddr + ')';
                        }
                        // 조합된 참고항목을 해당 필드에 넣는다.
                        document.getElementById("shipping-address").value = addr + " " + extraAddr;

                        // 우편번호와 주소 정보를 해당 필드에 넣는다.
                        document.getElementById('shipping-zipcode').value = data.zonecode;
                        // 커서를 상세주소 필드로 이동한다.
                        document.getElementById("shipping-address-detail").focus();
                    }
                }).open();
            }
        </script>
    </th:block>
</div>
</html>